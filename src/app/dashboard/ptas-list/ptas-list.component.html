<div class="mx-auto px-4 py-6 z-10 min-h-screen verflow-hidden backdrop-blur-sm">

  <h6 class="text-gray-800 text-2xl m-0"><span class="font-medium">Ptas</span></h6>
   <div class="grid !grid-cols-1 md:!grid-cols-2 gap-4 mb-4">
    <div class="w-full h-12 ">
      <div class="flex">

        <div class="w-auto">
            <select id="searchTypeSelect" (change)="onSearchTypeChange($event)" 
                    class="block w-auto pl-3 pr-10 py-2 text-sm text-gray-800 bg-gray-100 border-gray-400 focus:outline-none focus:ring-sky-800 focus:border-sky-800 sm:text-sm rounded-s-md cursor-pointer">
              <option value="title">Titre</option>
              <option value="date">Date</option>
            </select>
        </div>

        <div class="relative w-full " *ngIf="searchType === 'title'">
            <input 
            type="text" 
            id="searchInput" 
            placeholder="Rechercher par titre" 
            (input)="onSearch($event)" 
            class="block w-full pl-3 pr-3 py-2 text-sm text-black bg-white border-gray-400 focus:outline-none focus:ring-sky-800 focus:border-sky-800 sm:text-sm" />
        </div>

        <div class="relative w-full " *ngIf="searchType === 'date'">
                <input 
                  type="date" 
                  id="searchDate" 
                  (change)="onDateChange($event)" 
                  class="block w-full pl-3 pr-3 py-2 text-sm text-black bg-white border-gray-400 focus:outline-none focus:ring-sky-800 focus:border-sky-800 sm:text-sm rounded-md" />
        </div>
        
        <div class="flex justify-center items-center cursor-pointer bg-sky-900 p-1 rounded-e-md" (click)="resetFilters() ">
              <svg  xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 text-white dark:text-gray-800">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
              </svg>
          
        </div>
      </div>
    </div>

    <div class="w-full grid grid-cols-1 gap-1">
      <div class="flex flex-row justify-end">
        <div class="!w-auto">
          <select id="ptaTypeSelect" (change)="onTypeChange($event)" 
                  class="block w-full pl-3 pr-10 text-sm text-gray-100 bg-sky-900 border-gray-400 focus:outline-none focus:ring-sky-800 focus:border-sky-800 sm:text-sm rounded-s-md">
          <option *ngFor="let type of ptaTypes" [value]="type"><span class=""> {{ type }}</span></option>
          </select>
        </div>

        <div class="w-full md:w-auto flex-1 md:flex-none ">
          <select id="sousTypeSelect" (change)="onSousTypeChange($event)" 
                    class="block w-full pl-3 pr-10 text-sm text-gray-500 bg-gray-50 border-gray-400 focus:outline-none focus:ring-sky-800 focus:border-sky-800 sm:text-sm rounded-e-md">
            <option value="">Tous</option>
            <option *ngFor="let sousType of currentSousTypes" [value]="sousType">{{ sousType | replaceUnderscore }}</option>
            </select>
        </div>

      </div>

    </div>
   </div>
  
    <!-- Pta Table -->
    <div class="relative overflow-x-auto shadow-md sm:rounded-lg overflow-auto max-h-[480px]">
      <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
        <thead class="text-xs text-gray-700 uppercase whitespace-nowrap sticky top-0 backdrop-blur-lg shadow-lg z-10 bg-gray-200/30 dark:bg-gray-700 dark:text-gray-400">
            <tr class="">
                <th scope="col" class="px-4 py-3">Titre</th>
                <th scope="col" class="px-4 py-3">Date d'insertion</th>
                <th scope="col" class="px-4 py-3">Service</th>
                <th scope="col" class="px-4 py-3">inséré par</th>
                <th scope="col" class="px-4 py-3">Consulter</th>
                <th scope="col" class="px-4 py-3">
                    <span class="sr-only ">Actions</span>
                </th>
                <th scope="col" class="px-4 py-3"></th>
            </tr>
        </thead>
        <tbody  class="bg-white">
          <ng-container *ngFor="let pta of paginatedPtas; let i = index">
          <tr class="border-b dark:border-gray-700 whitespace-nowrap" [ngClass]="{'bg-red-100': !pta.valide, 'hover:bg-gray-100': pta.valide}">
            <th scope="row" class="px-4 py-3 font-bold text-gray-900 whitespace-nowrap dark:text-white">{{ pta.titre }}</th>
            <!-- if datemodification = null show pta.date.insertion else date.modification -->
                <td class="px-4 py-3">{{ pta.dateModification ? (pta.dateModification | date:'medium') : (pta.dateInsertion | date:'medium') }}</td>
                <td class="px-4 py-3 font-bold">{{ pta.sousType }}</td>
                <td class="px-4 py-3">{{ pta.user_account.numero }}</td>
  
                <td class="px-4 py-3">
                  <div class="flex flex-row gap-2">
                    <button class=" text-sky-900 px-2 py-1 rounded" (click)="downloadPta(pta)">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                      </svg>
                    </button>
  
                  <button class=" text-white px-2 py-1 rounded" (click)="previewPta(pta)">
                    <div class=" bg-yellow-500 flex flex-row gap-2 items-center justify-center px-2 py-1 rounded-md">
                      <div>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                        </svg>                      
                      </div>
                      <div>
                        Voir
                      </div>
                    </div>
                  </button>
                  </div>
                </td>
                <td class="px-4 py-3">
                  <div class="flex flex-row gap-2">
                    <button (click)="openConfirmModal(pta)" class="text-green-600 hover:underline" [ngClass]="{'hidden': pta.valide}">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6 transform hover:scale-125 ease-in duration-200 ">
                        <path fill-rule="evenodd" d="M8.603 3.799A4.49 4.49 0 0 1 12 2.25c1.357 0 2.573.6 3.397 1.549a4.49 4.49 0 0 1 3.498 1.307 4.491 4.491 0 0 1 1.307 3.497A4.49 4.49 0 0 1 21.75 12a4.49 4.49 0 0 1-1.549 3.397 4.491 4.491 0 0 1-1.307 3.497 4.491 4.491 0 0 1-3.497 1.307A4.49 4.49 0 0 1 12 21.75a4.49 4.49 0 0 1-3.397-1.549 4.49 4.49 0 0 1-3.498-1.306 4.491 4.491 0 0 1-1.307-3.498A4.49 4.49 0 0 1 2.25 12c0-1.357.6-2.573 1.549-3.397a4.49 4.49 0 0 1 1.307-3.497 4.49 4.49 0 0 1 3.497-1.307Zm7.007 6.387a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z" clip-rule="evenodd" />
                      </svg>                      
                    </button>
                  </div>
                </td>
                <td>
                  <button (click)="toggleRow(i, pta)" [ngClass]="{'hidden': pta.dateModification == null}"  class="flex items-center justify-between w-full p-2 font-medium text-gray-500 ">
                      <svg class="w-4 h-4" [ngClass]="expandedRowIndex === i ? 'rotate-180' : ''" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                  </button>
              </td>
            </tr>
          <!-- Ligne extensible -->
          <tr *ngIf="expandedRowIndex === i">
            <td colspan="8" class="px-4 py-3 bg-gray-50">
                <div *ngFor="let ptaAudit of ptasAudit" class="bg-blue-700/10 rounded-md p-2 mb-3 flex flex-row justify-between"> 
                    <div>
                      <p class="font-bold">contenue</p>
                      <button (click)="downloadPtaAudit(ptaAudit)" class="text-white px-2 py-1 rounded">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6 text-blue-700">
                          <path d="M3.375 3C2.339 3 1.5 3.84 1.5 4.875v.75c0 1.036.84 1.875 1.875 1.875h17.25c1.035 0 1.875-.84 1.875-1.875v-.75C22.5 3.839 21.66 3 20.625 3H3.375Z" />
                          <path fill-rule="evenodd" d="m3.087 9 .54 9.176A3 3 0 0 0 6.62 21h10.757a3 3 0 0 0 2.995-2.824L20.913 9H3.087ZM12 10.5a.75.75 0 0 1 .75.75v4.94l1.72-1.72a.75.75 0 1 1 1.06 1.06l-3 3a.75.75 0 0 1-1.06 0l-3-3a.75.75 0 1 1 1.06-1.06l1.72 1.72v-4.94a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                        </svg>
                      </button>
                    </div>
                    <div>
                      <p class="font-bold">date d'insertion</p>
                      <p>{{ ptaAudit.dateInsertion | date:'medium' }}</p>
                      <p class="font-bold"> date de modification : </p>
                      <p>{{ ptaAudit.auditTimestamp | date:'medium' }}</p>
                    </div>
                    <div>
                      <p class="font-bold">insérée par</p>
                      <p>{{ ptaAudit.userId }}</p>
  
                      <p class="font-bold">modifiée par</p>
                      <p>{{ ptaAudit.modifiedBy }}</p>
  
                    </div>
                    <div>
                      <p> {{ptaAudit.idAudit}}</p>
  
                    </div>
                  <hr>
                </div>
            </td>
        </tr>
        </ng-container>
  
        </tbody>
    </table>
  
      <!-- No Results Message -->
      <div *ngIf="filteredPtas.length === 0" class="text-center text-red-500 font-semibold ">
        Aucun résultat trouvé.
      </div>
    </div>
  
    <!-- Pagination Controls -->
    <div class="flex justify-between items-center mt-4 text-gray-400">
      <!-- Rows per page -->
      <div>
        <label for="rowsPerPage" class="mr-2">Lignes par page:</label>
        <select id="rowsPerPage" (change)="onRowsPerPageChange($event)" 
                class="bg-gray-50 border-gray-600 text-gray-800 rounded-md">
          <option [value]="5">5</option>
          <option [value]="10" selected>10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
        </select>
      </div>
  
      <!-- Pagination Buttons -->
      <div>
        <button class="px-4 py-2  text-gray-400 rounded-md" [disabled]="currentPage === 1" (click)="previousPage()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
              </svg>              
        </button>
        
        <button class="px-4 py-2  text-gray-400 rounded-md" [disabled]="currentPage >= totalPages" (click)="nextPage()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
              </svg>
              
        </button>
      </div>
    </div>
  

  
    <!-- Confirmation Modal -->
    <div *ngIf="isConfirmModalVisible" class="fixed inset-0 flex items-center justify-center bg-gray-300 bg-opacity-50 overflow-hidden">
      <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <h3 class="text-xl font-medium text-gray-900 mb-4">Confirmation</h3>
        <p>Êtes-vous sûr de vouloir valider ce PTA?</p>
        <div class="flex justify-end mt-4">
          <button (click)="confirmValiderPta()" class="text-white bg-green-600 hover:bg-green-700 rounded-lg text-sm px-5 py-2.5">Oui</button>
          <button (click)="closeConfirmModal()" class="text-gray-600 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm px-5 py-2.5 ml-2">Non</button>
        </div>
      </div>
    </div>
  </div>
  
  
  